var $jscomp={scope:{},findInternal:function(a,d,b){a instanceof String&&(a=String(a));for(var f=a.length,l=0;l<f;l++){var e=a[l];if(d.call(b,e,l,a))return{i:l,v:e}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,d,b,f){if(d){b=$jscomp.global;a=a.split(".");for(f=0;f<a.length-1;f++){var l=a[f];l in b||(b[l]={});b=b[l]}a=a[a.length-1];f=b[a];d=d(f);d!=f&&null!=d&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).i}},"es6-impl","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var d=0;return $jscomp.iteratorPrototype(function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var b=0,f={next:function(){if(b<a.length){var l=b++;return{value:d(l,a[l]),done:!1}}f.next=function(){return{done:!0,value:void 0}};return f.next()}};f[Symbol.iterator]=function(){return f};return f};
$jscomp.polyfill("Array.prototype.entries",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a,b){return[a,b]})}},"es6-impl","es3");
var devState="prod",c=document.getElementById("canvas"),ctx=c.getContext("2d"),tooltip=document.getElementById("tooltip"),offsetWidth=200,offsetHeight=60,cWidth=c.width-offsetWidth,margin=110,pxSize=10,txPerLine=Math.ceil(cWidth/pxSize),textColor="#000000",strokeColorNorm="#cccccc",strokeColorSelect="#ff0000",fontFace="Consolas",fontSizeHeader="13px",fontSizeAxis="11px",txAmountToPoll=15E3,maxTransactions=15E3,coordinator="KPWCHICGJZXKE9GSUDXZYUAPLHAKAHYHDXN",pxColorUnconf={r:0,g:0,b:0,a:1},pxColorConf=
{r:0,g:255,b:0,a:1},pxColorReattach={r:255,g:255,b:0,a:1},pxColorMilestone={r:0,g:0,b:255,a:1},txList=[],filterForValueTX=!1,selectedAddress="",totalConfRate=0,totalConfirmations=[],totalConfirmationTime=0,totalTransactions=0,totalTPS=0,totalCTPS=0,topList=[],toplistAdditional=0,topListCount=0,toplistSortIndex=[2,"desc"],toplistMinTX=10,mousePos,pixelMap=[],timer=[],rateLimiter=0,txOfMousePosition={},ChangeAddress=function(){selectedAddress=document.getElementById("address_input").value.substring(0,
81);document.getElementById("status").innerHTML="Address selection changed"};document.getElementById("address_button").onclick=function(){ChangeAddress()};
function createTable(a){a=_.filter(a,function(a){return a[2]>=toplistMinTX});a=_.orderBy(a,function(a){return a[toplistSortIndex[0]][0]},[toplistSortIndex[1]]);var d=document.getElementById("toplist");d.innerHTML="";var b=document.createElement("thead"),f=document.createElement("tbody"),l=document.createElement("tr");topListCount=0;15<=a.length?topListCount=15:topListCount=a.length;topListCount+=toplistAdditional;topListCount>=a.length?topListCount=a.length:0>topListCount&&(topListCount=0);if(0<a.length){for(var e=
0;e<topListCount;e++){for(var k=document.createElement("tr"),g={},h=0;h<a[0].length;g={current_cell:g.current_cell},h++){g.current_cell=document.createElement("td");g.current_cell.addEventListener("mouseenter",function(a){return function(){selectedAddress=a.current_cell.getAttribute("tx")}}(g),!1);g.current_cell.addEventListener("click",function(a){return function(){OpenLink(a.current_cell.getAttribute("tx"))}}(g),!1);var m=void 0;switch(h){case 0:m=""+(e+1);break;case 1:m=(a[e][1].substring(0,35)===
coordinator?"[COO]"+coordinator.substring(0,30):a[e][1].substring(0,35))+"...";break;case 2:m=""+a[e][2];break;case 3:m=a[e][3][0]+" ["+(100>a[e][3][1]?a[e][3][1].toFixed(1):a[e][3][1].toFixed(0))+"%]";break;case 4:m=a[e][4][0]+" ["+(100>a[e][4][1]?a[e][4][1].toFixed(1):a[e][4][1].toFixed(0))+"%]";break;case 5:m=""+(Infinity===a[e][5][0]?"inf.":a[e][5][0].toFixed(2));break;case 6:m=""+(Infinity===a[e][6][0]?"inf.":0<a[e][6][0]?"+":"")+(Infinity>a[e][6][0]?a[e][6][0].toFixed(0)+"%":"");break;case 7:m=
""+a[e][7][0].toFixed(2);break;case 8:m=""+a[e][8][0].toFixed(2);break;case 9:m=a[e][9][0].toFixed(1)+" min";break;case 10:m=""+(0<a[e][10][0]?"+":"")+a[e][10][0].toFixed(1)+"%";break;default:m="N/A"}m=document.createTextNode(m);g.current_cell.appendChild(m);g.current_cell.setAttribute("tx",a[e][1]);0<=a[e][6][0]&&6==h?g.current_cell.setAttribute("style","color: #008000"):0>a[e][6][0]&&6==h?g.current_cell.setAttribute("style","color: #ff0000"):0<=a[e][10][0]&&10==h?g.current_cell.setAttribute("style",
"color: #ff0000"):0>a[e][10][0]&&10==h&&g.current_cell.setAttribute("style","color: #008000");k.appendChild(g.current_cell)}f.appendChild(k)}for(e={i$0:0};e.i$0<a[0].length;e={i$0:e.i$0},e.i$0++){k=document.createElement("td");g=document.createElement("img");g.setAttribute("src","css/sort.png");g.classList.add("table_head_sortpic");h=void 0;switch(e.i$0){case 0:h="#";break;case 1:h="Address";break;case 2:h="Total";break;case 3:h="Confirmed";break;case 4:h="Unconfirmed";break;case 5:h="C.Ratio";break;
case 6:h="\u00b1Avg.C.Ratio";break;case 7:h="TPS";break;case 8:h="CTPS";break;case 9:h="~C.Time";break;case 10:h="\u00b1Avg.Time";break;default:h="N/A"}h=document.createTextNode(h);k.appendChild(h);0<e.i$0&&k.appendChild(g);l.appendChild(k);k.addEventListener("click",function(a){return function(){toplistSortIndex=a.i$0===toplistSortIndex[0]&&"desc"===toplistSortIndex[1]?[a.i$0,"asc"]:[a.i$0,"desc"];createTable(topList)}}(e),!1)}b.appendChild(l);d.appendChild(b);d.appendChild(f)}}
var GetMousePos=function(a,d){if(null==d.pageX&&null!=d.clientX){var b=document.documentElement,f=document.body;d.pageX=d.clientX+(b&&b.scrollLeft||f&&f.scrollLeft||0)-(b.clientLeft||0);d.pageY=d.clientY+(b&&b.scrollTop||f&&f.scrollTop||0)-(b.clientTop||0)}b=a.getBoundingClientRect();return{x:d.clientX-b.left,y:d.clientY-b.top,xReal:d.pageX,yReal:d.pageY}},GetTXofMousePosition=function(a){a.y-=offsetHeight;a.x-=margin;return pixelMap.reduce(function(d,b){a.x>=b.x&&a.x<b.x+pxSize&&a.y>=b.y&&a.y<b.y+
pxSize&&(d=b);return d},0)},OpenLink=function(a){a&&window.open("https://thetangle.org/address/"+a);txOfMousePosition.hash&&window.open("https://thetangle.org/transaction/"+txOfMousePosition.hash)};
c.addEventListener("mousemove",function(a){25<Date.now()-rateLimiter&&(mousePos=GetMousePos(c,a),txOfMousePosition=GetTXofMousePosition(mousePos),txOfMousePosition.hash?(a=_.round((txOfMousePosition.ctime-txOfMousePosition.time)/60,2),txOfMousePosition.confirmed?a+=" Minutes":a="Not confirmed yet",tooltip.innerHTML="Address: "+txOfMousePosition.address+"<br>TX Hash: "+txOfMousePosition.hash+"<br>Confirmation Time: "+a,selectedAddress=txOfMousePosition.address,tooltip.style.display="block",tooltip.style.top=
mousePos.yReal+15+"px",tooltip.style.left=mousePos.xReal+15+"px",document.body.style.cursor="pointer"):(tooltip.style.display="none",document.body.style.cursor="auto",txOfMousePosition={},selectedAddress=""),rateLimiter=Date.now())},!1);c.addEventListener("mouseout",function(){tooltip.style.display="none";document.body.style.cursor="auto";txOfMousePosition={};selectedAddress=""},!1);var checkBox=document.getElementById("hideZero");
document.getElementById("hideZero").addEventListener("click",function(){!0===checkBox.checked?(filterForValueTX=!0,txList=FilterZeroValue(txList)):(filterForValueTX=!1,InitialHistoryPoll(!1));CalcToplist(!1)},!1);checkBox.checked=!1;c.addEventListener("click",function(){OpenLink(!1)},!1);document.getElementById("toplist-more").addEventListener("click",function(){toplistAdditional+=5;createTable(topList)},!1);
document.getElementById("toplist-all").addEventListener("click",function(){toplistAdditional=1E4;createTable(topList)},!1);document.getElementById("toplist-reset").addEventListener("click",function(){toplistAdditional=0;createTable(topList)},!1);document.getElementById("minNumberOfTxIncluded_button").addEventListener("click",function(){toplistMinTX=parseInt(document.getElementById("minNumberOfTxIncluded").value);createTable(topList)},!1);
var calcLineCount=function(a,d,b){return Math.floor(a*d/b)},UpdateTXStatus=function(a,d){var b=a.hash,f=a.milestone,l=a.ctime,e=txList.findIndex(function(a){return a.hash===b});if(-1!==e&&void 0!==txList[e]){if("txConfirmed"===d||"Milestone"===d)txList[e].ctime=l,txList[e].confirmed=!0;"Milestone"===d&&(txList[e].milestone=f);"Reattach"===d&&(txList[e].reattached=!0)}else console.log(("Milestone"===d?"Milestone":"TX")+" not found in local DB - Hash: "+b+" | updateType: "+d)},DrawCanvas=function(a){for(ctx.clearRect(0,
0,cWidth+offsetWidth,c.height);c.height<timer.length*pxSize*2+offsetHeight+30;)c.height+=50;var d=[];a.map(function(a,f){var b=calcLineCount(f,pxSize,cWidth);d.push({x:f*pxSize-b*pxSize*txPerLine,y:b*pxSize,hash:a.hash,bundle:a.bundle,address:a.address,confirmed:a.confirmed,reattached:a.reattached,time:a.timestamp,ctime:a.ctime,milestone:a.milestone})});pixelMap=d;ctx.font=fontSizeHeader+" "+fontFace;ctx.fillStyle=textColor;ctx.textBaseline="hanging";ctx.textAlign="left";ctx.fillText("Total TX count    "+
totalTransactions,margin+10,10);ctx.fillText("Avg. TPS          "+totalTPS,margin+10,25);ctx.fillText("Avg. conf. rate   "+totalConfRate+" %",margin+10,40);ctx.fillText("Avg. conf. time  "+totalConfirmationTime+" min",margin+220,10);ctx.fillText("Avg. CTPS        "+totalCTPS,margin+220,25);ctx.fillText("Unconfirmed",cWidth-60,10);ctx.fillText("Confirmed",cWidth-60,25);ctx.fillText("Reattached",cWidth+40,10);ctx.fillText("Milestone",cWidth+40,25);ctx.fillStyle="rgba(0,0,0,1)";ctx.fillRect(cWidth-75,
10,pxSize,pxSize);ctx.fillStyle="rgba(0,255,0,1)";ctx.fillRect(cWidth-75,25,pxSize,pxSize);ctx.fillStyle="rgba(255,255,0,1)";ctx.fillRect(cWidth+25,10,pxSize,pxSize);ctx.fillStyle="rgba(0,0,255,1)";ctx.fillRect(cWidth+25,25,pxSize,pxSize);d.map(function(a,d){var b=2*txPerLine;if(0==d%b){var e=d/b;ctx.font=fontSizeAxis+" "+fontFace;ctx.fillStyle=textColor;ctx.textBaseline="hanging";ctx.textAlign="right";b=txList.slice(e*b,e*b+b);b=Math.round(b.filter(function(a){return!1!==a.confirmed}).length/b.length*
100);e=Math.round(2*txPerLine/(timer[e+1]-timer[e])*10)/10;ctx.fillText((isNaN(b)?"0":b)+"%"+(isNaN(e)?" [...]":" ["+e.toFixed(1)+" TPS]"),margin-5,a.y+offsetHeight+5)}var f,g;if(!1===a.confirmed||void 0===a.confirmed)f=pxColorUnconf,g=strokeColorNorm;!0===a.confirmed&&"f"===a.milestone&&!1===a.reattached?(f=pxColorConf,g=strokeColorNorm):!1===a.confirmed&&"f"===a.milestone&&!0===a.reattached&&(f=pxColorReattach,g=strokeColorNorm);"m"===a.milestone&&(ctx.font=fontSizeAxis+" "+fontFace,ctx.fillStyle=
textColor,ctx.textBaseline="hanging",ctx.textAlign="left",f=pxColorMilestone,g=strokeColorNorm,e=Math.floor((Math.floor(Date.now()/1E3)-a.time)/60),ctx.fillText(e+" min ago",margin+cWidth+5,a.y+offsetHeight));"t"===a.milestone&&(f=pxColorMilestone,g=strokeColorNorm);a.address===selectedAddress&&(g=strokeColorSelect);ctx.fillStyle="rgba("+f.r+","+f.g+","+f.b+","+f.a+")";ctx.fillRect(a.x+margin,a.y+offsetHeight,pxSize,pxSize);ctx.strokeStyle=g;ctx.lineWidth=1;ctx.strokeRect(a.x+margin,a.y+offsetHeight,
pxSize,pxSize)});window.setTimeout(function(){return DrawCanvas(txList)},100)},CalcToplist=function(a){var d=_.groupBy(txList,"confirmed"),b=_.countBy(d["true"],"address"),f=_.countBy(d["false"],"address"),l=d["true"].length,e=d["false"].length,k=_.assignInWith(b,f,function(a,b){a=_.defaultTo(a,0);return[a,b]}),k=Object.entries(k),k=k.reduce(function(a,b){Array.isArray(b[1])?a.push(b):a.push([b[0],[b[1],0]]);return a},[]);k.map(function(a,b){var f=a[1][1],g=a[1][0],h=d["true"].reduce(function(b,d){d.address===
a[0]?b[0].push(d.ctime-d.timestamp):b[1].push(d.ctime-d.timestamp);return b},[[],[]]),n=h[0],h=_.mean(h[1])/60,n=_.mean(n)/60,h=n/h*100-100,p=f+g,r=g/p*100,t=f/p*100,q=g/f,u=q/(l/e)*100-100,v=Math.round(p/((Date.now()-1E3*txList[0].timestamp)/1E3)*100)/100,w=Math.round(g/((Date.now()-1E3*txList[0].timestamp)/1E3)*100)/100;k[b].unshift([0]);k[b].pop();k[b].push([p]);k[b].push([g,r]);k[b].push([f,t]);k[b].push([q]);k[b].push([u]);k[b].push([v]);k[b].push([w]);k[b].push([n]);k[b].push([h])});topList=
k;0<k.length&&createTable(k);a&&window.setTimeout(function(){return CalcToplist(!0)},15E3)},CalcMetrics=function(){totalTransactions=txList.length;totalTransactions>=maxTransactions&&txList.splice(0,txPerLine*Math.floor(totalTransactions/maxTransactions));var a=[];txList.map(function(b,d){0===d%(2*txPerLine)&&a.push(b.timestamp)});timer=a;var d=0;totalConfirmations=txList.reduce(function(a,f){!0===f.reattached&&d++;!0===f.confirmed&&a.push(f.ctime-f.timestamp);return a},[]);totalConfRate=Math.round(totalConfirmations.length/
(totalTransactions-d)*1E4)/100;totalConfirmationTime=_.mean(totalConfirmations);totalConfirmationTime=_.round(totalConfirmationTime/60,1);0<totalTransactions&&(totalTPS=Math.round(totalTransactions/((Date.now()-1E3*txList[0].timestamp)/1E3)*100)/100,totalCTPS=Math.round(totalConfirmations.length/((Date.now()-1E3*txList[0].timestamp)/1E3)*100)/100);maxTransactions=15<totalTPS?3E4:15E3;window.setTimeout(function(){return CalcMetrics()},1500)},InitialHistoryPoll=function(a){var d="";"prod"===devState?
d="https://junglecrowd.org:4433/api/v1/getRecentTransactions?amount=15000":d="http://localhost:8081/api/v1/getRecentTransactions?amount="+txAmountToPoll;fetch(d,{cache:"no-cache"}).then(function(a){return a.json()}).then(function(b){document.getElementById("loading").style.display="none";filterForValueTX&&(b.txHistory=FilterZeroValue(b.txHistory));txList=_.reverse(b.txHistory);CalcMetrics();a&&CalcToplist(!0);a&&InitWebSocket()})["catch"](function(b){console.error("Error fetching txHistory",b);window.setTimeout(function(){return InitialHistoryPoll(a)},
2500)})},InitWebSocket=function(){var a="";"prod"===devState?a="wss://junglecrowd.org:4433":a="ws://localhost:8080";var d=new WebSocket(a,["soap","xmpp"]);d.onopen=function(){d.send("Gimme transactions!")};d.onerror=function(){console.log("WebSocket Connection Error.")};d.onclose=function(){console.log("Websocket disconnected. Reconnecting..");window.setTimeout(function(){return InitWebSocket()},3E3);d.terminate()};d.onmessage=function(a){a=JSON.parse(a.data);a.newTX?filterForValueTX&&0!==a.newTX.value?
txList.push(a.newTX):filterForValueTX||txList.push(a.newTX):a.update?UpdateTXStatus(a.update,"txConfirmed"):a.updateMilestone?UpdateTXStatus(a.updateMilestone,"Milestone"):a.updateReattach?UpdateTXStatus(a.updateReattach,"Reattach"):console.log("Unrecognized message from Websocket: "+a)}},FilterZeroValue=function(a){return _.filter(a,function(a){return 0!==a.value})},Main=function(){DrawCanvas(txList);InitialHistoryPoll(!0)};Main();
